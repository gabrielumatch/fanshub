{% extends 'base.html' %}

{% block title %}{{ post.title }} - FansHub{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <!-- Post Card -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <!-- Post Header -->
          <div class="d-flex align-items-center mb-3">
            <img src="{{ post.creator.profile_picture.url|default:'/static/images/default-profile.png' }}" 
                 alt="{{ post.creator.username }}" 
                 class="rounded-circle me-2"
                 style="width: 40px; height: 40px; object-fit: cover;">
            <div>
              <h5 class="mb-0">{{ post.creator.username }}</h5>
              <small class="text-muted">{{ post.created_at|timesince }} ago</small>
            </div>
          </div>

          <!-- Post Content -->
          <h2 class="card-title mb-3">{{ post.title }}</h2>
          <p class="card-text">{{ post.content }}</p>

          <!-- Post Media -->
          {% if post.media %}
          <div class="mb-3">
            {% if post.media_type == 'image' %}
            <img src="{{ post.media.url }}" alt="Post media" class="img-fluid rounded">
            {% elif post.media_type == 'video' %}
            <video controls class="w-100 rounded">
              <source src="{{ post.media.url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            {% endif %}
          </div>
          {% endif %}

          <!-- Post Price -->
          {% if post.price %}
          <div class="alert alert-info">
            <i class="bi bi-tag"></i> This content is available for ${{ post.price }}
          </div>
          {% endif %}

          <!-- Post Actions -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
              <button class="btn btn-outline-primary btn-sm me-2" onclick="likePost({{ post.id }})">
                <i class="bi bi-heart{% if post.is_liked %} text-danger{% endif %}"></i>
                <span id="like-count">{{ post.likes.count }}</span>
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="focusComment()">
                <i class="bi bi-chat"></i>
                <span>{{ post.comments.count }}</span>
              </button>
            </div>
            {% if user == post.creator %}
            <div>
              <a href="{% url 'edit_post' post.id %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-pencil"></i> Edit
              </a>
              <button class="btn btn-outline-danger btn-sm" onclick="deletePost({{ post.id }})">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="card shadow">
        <div class="card-body">
          <h5 class="card-title mb-3">Comments</h5>

          <!-- Comment Form -->
          {% if user.is_authenticated %}
          <form method="post" action="{% url 'add_comment' post.id %}" class="mb-4">
            {% csrf_token %}
            <div class="mb-3">
              <textarea class="form-control" name="content" rows="3" placeholder="Write a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
          </form>
          {% else %}
          <div class="alert alert-info">
            Please <a href="{% url 'login' %}">login</a> to leave a comment.
          </div>
          {% endif %}

          <!-- Comments List -->
          <div class="comments-list">
            {% for comment in post.comments.all %}
            <div class="comment mb-3">
              <div class="d-flex">
                <img src="{{ comment.user.profile_picture.url|default:'/static/images/default-profile.png' }}" 
                     alt="{{ comment.user.username }}" 
                     class="rounded-circle me-2"
                     style="width: 32px; height: 32px; object-fit: cover;">
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between">
                    <h6 class="mb-0">{{ comment.user.username }}</h6>
                    <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                  </div>
                  <p class="mb-0">{{ comment.content }}</p>
                </div>
              </div>
            </div>
            {% empty %}
            <p class="text-muted text-center">No comments yet. Be the first to comment!</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if user.is_authenticated %}
<script>
function likePost(postId) {
  fetch(`/api/posts/${postId}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    const likeButton = document.querySelector('.btn-outline-primary');
    const likeCount = document.getElementById('like-count');
    
    if (data.liked) {
      likeButton.querySelector('i').classList.add('text-danger');
    } else {
      likeButton.querySelector('i').classList.remove('text-danger');
    }
    
    likeCount.textContent = data.likes_count;
  });
}

function deletePost(postId) {
  if (confirm('Are you sure you want to delete this post?')) {
    fetch(`/api/posts/${postId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = "{% url 'creator_dashboard' %}";
      }
    });
  }
}

function focusComment() {
  document.querySelector('textarea[name="content"]').focus();
}
</script>
{% endif %}
{% endblock %} 